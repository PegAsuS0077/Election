name: Publish Election Results to R2

on:
  schedule:
    # Runs every minute. GitHub Actions minimum cron interval is 1 minute.
    # Note: GitHub may delay scheduled runs by a few minutes under high load.
    - cron: "* * * * *"
  # Allow manual trigger from GitHub Actions UI for testing
  workflow_dispatch:

jobs:
  publish:
    name: Fetch → Parse → Upload to R2
    runs-on: ubuntu-latest
    timeout-minutes: 3

    defaults:
      run:
        working-directory: backend

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.13
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"
          cache: "pip"
          cache-dependency-path: backend/requirements.txt

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Fetch, parse, and upload to R2
        env:
          R2_ACCOUNT_ID:        ${{ secrets.R2_ACCOUNT_ID }}
          R2_ACCESS_KEY_ID:     ${{ secrets.R2_ACCESS_KEY_ID }}
          R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          R2_BUCKET:            ${{ secrets.R2_BUCKET }}
        run: python publish_to_r2.py

      - name: Report status
        if: failure()
        run: echo "publish_to_r2.py exited with a non-zero status — check logs above"
