// Generates src/districtPaths.ts with integer-coordinate SVG paths
const ng = require("nepal-geojson");
const fs = require("fs");

const fc = ng.districts();
const MIN_LNG = 80.050926, MAX_LNG = 88.204673;
const MIN_LAT = 26.348379, MAX_LAT = 30.47146;
const VIEW_W = 900, VIEW_H = 450, PAD = 10;

function project(lng, lat) {
  const x = Math.round(PAD + ((lng - MIN_LNG) / (MAX_LNG - MIN_LNG)) * (VIEW_W - PAD * 2));
  const y = Math.round(PAD + ((MAX_LAT - lat) / (MAX_LAT - MIN_LAT)) * (VIEW_H - PAD * 2));
  return [x, y];
}

function ringToPath(ring) {
  // Skip points within 1px manhattan distance of previous point (simplification)
  const pts = [];
  let prev = null;
  for (const coord of ring) {
    const pt = project(coord[0], coord[1]);
    if (prev === null || Math.abs(pt[0] - prev[0]) + Math.abs(pt[1] - prev[1]) >= 1) {
      pts.push(pt);
      prev = pt;
    }
  }
  return "M " + pts.map(([x, y]) => x + "," + y).join(" L ") + " Z";
}

const PROVINCE_MAP = {
  1: "Koshi", 2: "Madhesh", 3: "Bagmati", 4: "Gandaki",
  5: "Lumbini", 6: "Karnali", 7: "Sudurpashchim",
};

const NORMALIZE = {
  "KAVREPALANCHOWK": "Kavre",
  "NAWALPUR": "Nawalparasi-E",
  "PARASI": "Nawalparasi-W",
  "DHANUSA": "Dhanusha",
  "TERHATHUM": "Terhathum",
  "EASTERN RUKUM": "Rukum-E",
  "WESTERN RUKUM": "Rukum-W",
  "KAPILBASTU": "Kapilvastu",
  "CHITAWAN": "Chitwan",
  "MAKAWANPUR": "Makwanpur",
};

const entries = [];

for (const feature of fc.features) {
  const rawKey = feature.properties.DISTRICT;
  const name = NORMALIZE[rawKey] || (rawKey.charAt(0) + rawKey.slice(1).toLowerCase());
  const province = PROVINCE_MAP[feature.properties.PROVINCE];
  const geom = feature.geometry;

  let ring;
  if (geom.type === "Polygon") {
    ring = geom.coordinates[0];
  } else {
    // MultiPolygon: pick largest ring
    ring = geom.coordinates.reduce(
      (best, poly) => (poly[0].length > best.length ? poly[0] : best),
      []
    );
  }

  const d = ringToPath(ring);

  const projPts = ring.map((coord) => project(coord[0], coord[1]));
  const xs = projPts.map((p) => p[0]);
  const ys = projPts.map((p) => p[1]);
  const labelX = Math.round((Math.min(...xs) + Math.max(...xs)) / 2);
  const labelY = Math.round((Math.min(...ys) + Math.max(...ys)) / 2);

  entries.push({ name, province, d, labelX, labelY });
}

// Sort by name for stable output
entries.sort((a, b) => a.name.localeCompare(b.name));

const lines = [
  "// Auto-generated by scripts/gen-district-paths.cjs â€” do not edit manually",
  "export const DISTRICT_PATHS: Record<string, { province: string; d: string; labelX: number; labelY: number }> = {",
];

for (const { name, province, d, labelX, labelY } of entries) {
  lines.push(
    "  " + JSON.stringify(name) + ": { province: " + JSON.stringify(province) +
    ", labelX: " + labelX + ", labelY: " + labelY + ", d: " + JSON.stringify(d) + " },"
  );
}

lines.push("};");
lines.push("");

fs.writeFileSync("./src/districtPaths.ts", lines.join("\n"));
console.log("Written", entries.length, "districts to src/districtPaths.ts");
